<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset=utf-8>
    <meta name="theme-color" content="#557755" />
    <title>BinViewer</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <script src="datareader.js"></script>
    <script>

        var curRenderer;

        document.addEventListener("DOMContentLoaded", function(event) { 
            setup();
        });

        function setup() {
            if (typeof window.FileReader === 'undefined') {
                setStatus('Error: File API and/or FileReader API not supported.');
                document.getElementById("topContainer").style.display = "none";
                return;
            } else {
                setStatus("");
            }

            document.getElementById("fileBrowseInput").addEventListener("change", function(event) {
                processFile(event.target.files[0]);
            });
            document.getElementById("fileBrowseButton").addEventListener("click", function(event) {
                document.getElementById("fileBrowseInput").click();
            });

            document.getElementById("savePngLink").addEventListener("click", function(event) {
                openBase64UrlInNewWindow(document.getElementById("previewCanvas").toDataURL("image/png"));
            });
            document.getElementById("saveJpgLink").addEventListener("click", function(event) {
                openBase64UrlInNewWindow(document.getElementById("previewCanvas").toDataURL("image/jpeg"));
            });

            document.getElementById("udBmpScale").addEventListener("change", function(ev) {
                var canvas = document.getElementById("previewCanvas");
                var scaleVal = document.getElementById("udBmpScale").value;
                canvas.style.transform = "scale(" + scaleVal + ")";
            });
            document.getElementById("udBmpWidth").addEventListener("change", function(ev) {
                renderCurrentBitmap();
            });
            document.getElementById("udFileOffset").addEventListener("change", function(ev) {
                renderCurrentBitmap();
            });
            document.getElementById("selectBmpType").addEventListener("change", function(ev) {
                renderCurrentBitmap();
            });
            document.getElementById("rangeFileOffset").addEventListener("input", function(ev) {
                onScrollBarChanged();
            });
            document.getElementById("rangeFileOffset").addEventListener("change", function(ev) {
                onScrollBarChanged();
            });

            var holder = document.getElementById("holder");

            holder.addEventListener("dragover", function(ev) {
                ev.preventDefault();
                if(!holder.classList.contains("dragover")) {
                    holder.classList.add("hover");
                }
            });
        
            holder.addEventListener("dragend", function(ev) {
                ev.preventDefault();
                holder.classList.remove("hover");
            });

            holder.addEventListener("dragleave", function(ev) {
                ev.preventDefault();
                holder.classList.remove("hover");
            });

            holder.addEventListener("drop", function(ev) {
                ev.preventDefault();
                holder.classList.remove("hover");
                if (!ev.dataTransfer) {
                    console.log("No data found in dropped object.");
                    return;
                }
                processFile(ev.dataTransfer.files[0]);
            });
        }

        function processFile(file) {
            setStatus("");
            if(file == null){
                setStatus("Whatever was dropped is not a file.");
                return;
            }
            var reader = new FileReader();
            reader.onload = function (event) {
                var buf = event.target.result;
                var dataView = new DataView(buf);
                var reader = new DataReader(dataView);
                curRenderer = new FileBmpRenderer(reader)

                document.getElementById("drophint").style.display = "none";
                document.getElementById("previewCanvas").style.display = "inline";
                clearCanvas();

                renderCurrentBitmap();
            };
            reader.readAsArrayBuffer(file);
        }

        function onScrollBarChanged() {
            if (curRenderer) {
                var totalLength = curRenderer.length();
                var rangeVal = document.getElementById("rangeFileOffset").value;
                var rangeMax = document.getElementById("rangeFileOffset").max;

                document.getElementById("udFileOffset").value = parseInt((totalLength * rangeVal / rangeMax));
                renderCurrentBitmap();
            }
        }

        function renderCurrentBitmap() {
            if (!curRenderer) {
                return;
            }
            var holder = document.getElementById("holder");

            var bmpType = document.getElementById("selectBmpType").value;
            var offset = document.getElementById("udFileOffset").value;
            var context = document.getElementById("previewCanvas").getContext('2d');
            var width = document.getElementById("udBmpWidth").value;
            var height = holder.clientHeight;

            resizeCanvas(width, height);

            //this.reader.createImageData(imgWidth, imgHeight);
            var imageData = context.getImageData(0, 0, width, height);
            curRenderer.render(imageData, width, height, offset, bmpType);
            context.putImageData(imageData, 0, 0);
        }

        function setStatus(status) {
            var fileReaderStatus = document.getElementById("fileReaderStatus");
            if (status.length > 0) {
                fileReaderStatus.style.display = "block";
                fileReaderStatus.innerHTML = status;
            } else {
                fileReaderStatus.style.display = "none";
            }
        }

        function resizeCanvas(width, height) {
            var canvas = document.getElementById("previewCanvas");
            canvas.width = width;
            canvas.height = height;
            //var scaledHeight = height > 320 ? 320 : height;
            //var scaledWidth = width * (scaledHeight / height);
            canvas.style.width = width.toString() + "px";
            canvas.style.height = height.toString() + "px";
        }

        function clearCanvas() {
            var canvas = document.getElementById("previewCanvas");
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }

        function openBase64UrlInNewWindow(base64URL){
            window.open().document.write('<iframe src="' + base64URL + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
        }

    </script>
</head>
<body>

<h1 class="centered">BinViewer</h1>

<div class="status centered" id="fileReaderStatus">
    Loading...
</div>

<div class="topcontainer">

    <label for="selectBmpType">Bitmap type:</label>
    <select name="selectBmpType" id="selectBmpType">
        <option value="rgb24">24-bit RGB</option>
        <option value="rgb32">32-bit RGB</option>
        <option value="rgba32">32-bit RGBA</option>
        <option value="argb32">32-bit ARGB</option>
        <option value="565">16-bit 5-6-5</option>
        <option value="grey8">8-bit greyscale</option>
        <option value="ega4">4-bit EGA colors</option>
        <option value="mono1">1-bit monochrome</option>
        <option value="mono1inv">1-bit mono (invert)</option>
    </select>

    <label for="udBmpWidth">Width:</label> <input name="udBmpWidth" id="udBmpWidth" type="number" min="0" max="8192" step="1" value="320">

    <label for="udBmpScale">Scale:</label> <input name="udBmpScale" id="udBmpScale" type="number" min="1" max="16" step="1" value="1">
    <br />

    <label for="udFileOffset">Offset:</label> <input name="udFileOffset" id="udFileOffset" type="number" min="0" max="2147483648" step="1" value="0">
    <br />

    <input type="range" min="0" max="10000" value="0" id="rangeFileOffset" style="width: 100%;">

</div>

<div class="topcontainer" id="topContainer">

    <div class="previewcontainer">
        <div id="holder" style="height: 640px;">

            <span id="drophint">Drag-and-drop a file here</span>

            <canvas id="previewCanvas"></canvas>

        </div>

        <div style="text-align:right">
            <input type="file" id="fileBrowseInput" name="fileBrowse" style="display: none" />
            <span class="buttonLink browseButton"><a href="#" id="fileBrowseButton">Browse...</a></span>
            <span class="buttonLink"><a href="#" id="savePngLink" target="_blank">Save as PNG</a></span>
            <span class="buttonLink"><a href="#" id="saveJpgLink" target="_blank">Save as JPG</a></span>
        </div>
    </div>

</div>

<div class="footer centered">
    All processing is done client-side; nothing is uploaded anywhere.<br />
    Copyright &copy; 2022 <a href="https://dmitrybrant.com">Dmitry Brant</a>. <a href="https://github.com/dbrant/BinViewer">Source code</a> on GitHub.
</div>

</body>
</html>
